<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Admin Dashboard</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-request.htmx-indicator {
            display: inline-block;
        }
    </style>
</head>

<body>    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Global Elective Admin Dashboard</h1>
        
        <!-- Admin Actions Section (Collapsible) -->
        <div class="mb-8">
            <button id="admin-actions-toggle" onclick="toggleAdminActions()" 
                    class="w-full flex items-center justify-between bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-lg p-4 mb-4 transition-colors duration-200">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-red-700">Admin Actions</h2>
                    <span class="text-sm text-gray-600">(Click to expand)</span>
                </div>
                <svg id="admin-actions-chevron" class="w-5 h-5 text-gray-500 transform transition-transform duration-200" 
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div id="admin-actions-content" class="hidden">
                <!-- Course Creation Section -->
                <div class="bg-white shadow-md rounded-lg p-6 mb-4">
                    <h3 class="text-lg font-semibold mb-4">Create Course</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                            <input type="text" id="courseCode" placeholder="e.g., CS101" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                            <input type="text" id="courseName" placeholder="e.g., Introduction to Computer Science" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Offering Department</label>
                            <input type="text" id="offeringDepartment" placeholder="e.g., Computer Science" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Available Seats</label>
                            <input type="number" id="seatsAvailable" placeholder="e.g., 30" min="1" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bulk Course JSON (Optional)</label>
                        <textarea id="bulkCourseJson" rows="4" placeholder='[{"courseCode": "CS101", "courseName": "Intro to CS", "offeringDepartment": "CSE", "seatsAvailable": 30}]'
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Leave individual fields empty to use bulk JSON format</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="createCourse()" 
                                class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Create Course
                        </button>
                        <button onclick="clearCourseForm()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Clear Form
                        </button>
                    </div>
                    <div id="course-creation-result" class="mt-4"></div>
                </div>                <!-- Reset Operations Section -->
                <div class="bg-white shadow-md rounded-lg p-6 mb-4">
                    <h3 class="text-lg font-semibold mb-4 text-red-700">Reset Operations</h3>
                    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
                        <p class="text-sm text-red-800">
                            <strong>Warning:</strong> These operations are irreversible and will permanently delete data.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="confirmReset('courses')" 
                                class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            Reset All Courses
                        </button>
                        <button onclick="confirmReset('users')" 
                                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Reset All Users
                        </button>
                        <button onclick="confirmReset('all')" 
                                class="px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-700">
                            Reset Everything
                        </button>
                    </div>
                    <div id="reset-operation-result" class="mt-4"></div>
                </div>

                <!-- Access Control Section -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 text-blue-700">Access Control Settings</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong>Info:</strong> Control when users can access the system by setting an allowed date and time.
                        </p>
                    </div>
                    
                    <!-- Current Status -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-md">
                        <h4 class="font-medium mb-2">Current Status</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Current Time:</span>
                                <span id="current-time" class="font-mono ml-2">Loading...</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Access Status:</span>
                                <span id="access-status" class="ml-2 px-2 py-1 rounded text-xs font-medium">Loading...</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Allowed From:</span>
                                <span id="allowed-time" class="font-mono ml-2">Loading...</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Control Enabled:</span>
                                <span id="control-enabled" class="ml-2 px-2 py-1 rounded text-xs font-medium">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Form -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Allowed Date & Time</label>
                            <input type="datetime-local" id="allowedDateTime" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="isEnabled" checked
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">Enable Access Control</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="updateAccessSettings()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Update Settings
                        </button>
                        <button onclick="loadAccessSettings()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Reload Current Settings
                        </button>
                    </div>
                    <div id="access-settings-result" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Course Count Display -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4">
            <div class="flex items-center">
                <div class="flex-1">
                    <p class="text-lg font-medium">Live Course Statistics</p>
                    <p class="text-sm">Total Courses: <span id="course-count" class="font-bold">Loading...</span></p>
                    <div class="flex items-center justify-between space-x-2 mt-2">

                        <p class="text-sm">Connection Status: <span id="connection-status"
                            class="font-bold text-green-600">Connecting...</span></p>
                                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse" id="status-indicator"></div>
                        </div>
                    <div class="flex items-center justify-between space-x-2 mt-2">
                        <p class="text-sm">Auto-refresh: <span id="auto-refresh-status" class="font-bold">Every
                                5s</span></p>
                        <button id="toggle-refresh"
                            class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                            Pause
                        </button>
                    </div>

                </div>
            
            </div>
        </div>        <!-- Course Statistics Table -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Course Enrollment Statistics</h2>
                <div class="flex items-center space-x-2">
                    <span id="course-refresh-indicator" class="htmx-indicator">
                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    <button onclick="refreshCourseData()"
                        class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                        Refresh Courses
                    </button>
                    <span class="text-xs text-gray-500 last-updated"></span>
                </div>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table class="table-auto w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Course Code</th>
                            <th class="px-4 py-2 text-left">Course Name</th>
                            <th class="px-4 py-2 text-left">Department</th>
                            <th class="px-4 py-2 text-left">Available Seats</th>
                            <th class="px-4 py-2 text-left">Enrolled</th>
                            <th class="px-4 py-2 text-left">Total Capacity</th>
                            <th class="px-4 py-2 text-left">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="course-statistics-table" hx-post="/admin/courses"
                        hx-headers='js:{"Authorization": password}' hx-swap="innerHTML"
                        hx-trigger="load, every 5s from:body" hx-indicator="#course-refresh-indicator">
                        <tr>
                            <td colspan="7" class="border px-4 py-2 text-center">
                                Loading course statistics...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>        </div>

        <!-- User Table -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">User Data</h2>
                <div class="flex items-center space-x-2">
                    <span id="user-refresh-indicator" class="htmx-indicator">
                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    <button onclick="refreshUserData()"
                        class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                        Refresh Users
                    </button>
                    <span class="text-xs text-gray-500 last-updated"></span>
                </div>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">                <script>
                    var password = sessionStorage.getItem('adminPassword');
                    
                    function requirePassword() {
                        while (!password) {
                            password = prompt("Enter Admin Password to access the dashboard:", "");
                            if (password === null) {
                                // User pressed Cancel or Escape
                                alert("Admin password is required to access this dashboard. The page will reload.");
                                window.location.reload();
                                return false;
                            } else if (password.trim() === "") {
                                // User entered empty string
                                password = null;
                                alert("Password cannot be empty. Please enter a valid password.");
                            } else {
                                // Valid password entered
                                sessionStorage.setItem('adminPassword', password);
                                return true;
                            }
                        }
                        return true;
                    }
                      // Ensure password is required before continuing
                    if (!requirePassword()) {
                        throw new Error("Authentication required");
                    }                    // Helper function to validate password before API calls
                    function validatePassword() {
                        if (!password || password.trim() === "") {
                            alert("Session expired. Please enter your password again.");
                            sessionStorage.removeItem('adminPassword');
                            return requirePassword();
                        }
                        return true;
                    }

                    // Helper function to validate password with timeout support
                    function validatePasswordWithTimeout() {
                        return validatePassword();
                    }

                    // Function to get validated password for HTMX headers
                    function getValidatedPassword() {
                        if (!validatePassword()) {
                            throw new Error("Authentication required");
                        }
                        return password;
                    }

                    // Auto-refresh control variables
                    let autoRefreshEnabled = true;
                    let refreshInterval = null;

                    // WebSocket connection for real-time course count
                    const socket = io();

                    socket.on('connect', () => {
                        console.log('Connected to WebSocket server');
                        document.getElementById('connection-status').textContent = 'Connected';
                        document.getElementById('connection-status').className = 'font-bold text-green-600';
                        document.getElementById('status-indicator').className = 'w-3 h-3 bg-green-500 rounded-full';

                        // Request initial course count and statistics
                        socket.emit('requestCourseCount');
                        socket.emit('requestCourseStatistics');

                        // Start auto-refresh for WebSocket data
                        startAutoRefresh();
                    });

                    socket.on('disconnect', () => {
                        console.log('Disconnected from WebSocket server');
                        document.getElementById('connection-status').textContent = 'Disconnected';
                        document.getElementById('connection-status').className = 'font-bold text-red-600';
                        document.getElementById('status-indicator').className = 'w-3 h-3 bg-red-500 rounded-full';

                        // Stop auto-refresh when disconnected
                        stopAutoRefresh();
                    });

                    socket.on('courseCountUpdate', (data) => {
                        console.log('Course count update received:', data);
                        document.getElementById('course-count').textContent = data.totalCourses;
                    });

                    socket.on('courseStatisticsUpdate', (data) => {
                        console.log('Course statistics update received:', data);
                        updateCourseStatistics(data.courses);
                    });

                    socket.on('connect_error', (error) => {
                        console.error('WebSocket connection error:', error);
                        document.getElementById('connection-status').textContent = 'Connection Error';
                        document.getElementById('connection-status').className = 'font-bold text-red-600';
                        document.getElementById('status-indicator').className = 'w-3 h-3 bg-red-500 rounded-full';
                    });

                    // Function to update course statistics in real-time
                    function updateCourseStatistics(courses) {
                        courses.forEach(course => {
                            const seatsElement = document.getElementById(`seats-${course.courseCode}`);
                            const enrolledElement = document.getElementById(`enrolled-${course.courseCode}`);
                            const totalCapacityElement = document.getElementById(`total-capacity-${course.courseCode}`);
                            const percentageElement = document.getElementById(`percentage-${course.courseCode}`);

                            if (seatsElement) seatsElement.textContent = course.seatsAvailable;
                            if (enrolledElement) enrolledElement.textContent = course.enrolledCount;
                            if (totalCapacityElement) totalCapacityElement.textContent = course.totalCapacity;
                            if (percentageElement) percentageElement.textContent = course.enrollmentPercentage + '%';

                            // Update progress bar
                            const progressBar = document.querySelector(`#course-row-${course.courseCode} .bg-blue-600`);
                            if (progressBar) {
                                progressBar.style.width = course.enrollmentPercentage + '%';
                            }
                        });
                    }

                    // Auto-refresh functions
                    function startAutoRefresh() {
                        if (refreshInterval) clearInterval(refreshInterval);

                        refreshInterval = setInterval(() => {
                            if (autoRefreshEnabled && socket.connected) {
                                console.log('Auto-refreshing WebSocket data...');
                                socket.emit('requestCourseCount');
                                socket.emit('requestCourseStatistics');
                            }
                        }, 5000); // 5 seconds for WebSocket data
                    }

                    function stopAutoRefresh() {
                        if (refreshInterval) {
                            clearInterval(refreshInterval);
                            refreshInterval = null;
                        }
                    }

                    function toggleAutoRefresh() {
                        autoRefreshEnabled = !autoRefreshEnabled;
                        const toggleButton = document.getElementById('toggle-refresh');
                        const statusElement = document.getElementById('auto-refresh-status');

                        if (autoRefreshEnabled) {
                            toggleButton.textContent = 'Pause';
                            toggleButton.className = 'px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600';
                            statusElement.textContent = 'Every 5s';
                            statusElement.className = 'font-bold text-green-600';

                            // Re-enable HTMX polling
                            document.body.setAttribute('hx-trigger', 'load');

                            // Restart WebSocket auto-refresh
                            if (socket.connected) {
                                startAutoRefresh();
                            }
                        } else {
                            toggleButton.textContent = 'Resume';
                            toggleButton.className = 'px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600';
                            statusElement.textContent = 'Paused';
                            statusElement.className = 'font-bold text-red-600';

                            // Disable HTMX polling by removing trigger
                            document.body.removeAttribute('hx-trigger');

                            // Stop WebSocket auto-refresh
                            stopAutoRefresh();
                        }
                    }

                    // Add event listener for toggle button
                    document.addEventListener('DOMContentLoaded', () => {
                        const toggleButton = document.getElementById('toggle-refresh');
                        if (toggleButton) {
                            toggleButton.addEventListener('click', toggleAutoRefresh);
                        }
                    });

                    // Manual refresh functions
                    function refreshCourseData() {
                        console.log('Manually refreshing course data...');
                        htmx.trigger('#course-statistics-table', 'refresh');
                        if (socket.connected) {
                            socket.emit('requestCourseStatistics');
                        }
                    }

                    function refreshUserData() {
                        console.log('Manually refreshing user data...');
                        const userTable = document.querySelector('[hx-post="/admin/users"]');
                        if (userTable) {
                            htmx.trigger(userTable, 'refresh');
                        }
                    }                    // Add keyboard shortcuts
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey) {
                            switch (e.key) {
                                case 'r':
                                    e.preventDefault();
                                    refreshCourseData();
                                    refreshUserData();
                                    break;
                                case 'c':
                                    e.preventDefault();
                                    refreshCourseData();
                                    break;
                                case 'u':
                                    e.preventDefault();
                                    refreshUserData();
                                    break;
                                case 'p':
                                    e.preventDefault();
                                    toggleAutoRefresh();
                                    break;
                                case 'n':
                                    e.preventDefault();
                                    // Toggle admin actions first if hidden, then focus on course code
                                    const content = document.getElementById('admin-actions-content');
                                    if (content.classList.contains('hidden')) {
                                        toggleAdminActions();
                                    }
                                    setTimeout(() => {
                                        document.getElementById('courseCode').focus();
                                    }, 100);
                                    break;                                case 'a':
                                    e.preventDefault();
                                    toggleAdminActions();
                                    break;
                                case 's':
                                    e.preventDefault();
                                    updateAccessSettings();
                                    break;
                                case 'l':
                                    e.preventDefault();
                                    loadAccessSettings();
                                    break;
                            }
                        }
                        if (e.ctrlKey && e.shiftKey) {
                            switch (e.key) {
                                case 'Delete':
                                    e.preventDefault();
                                    // Open admin actions if hidden before confirming reset
                                    const content = document.getElementById('admin-actions-content');
                                    if (content.classList.contains('hidden')) {
                                        toggleAdminActions();
                                    }
                                    setTimeout(() => {
                                        confirmReset('all');
                                    }, 100);
                                    break;
                            }
                        }
                    });

                    // Show last updated time
                    function updateLastRefreshTime() {
                        const now = new Date().toLocaleTimeString();
                        const statusElements = document.querySelectorAll('.last-updated');
                        statusElements.forEach(el => {
                            el.textContent = `Last updated: ${now}`;
                        });
                    }                    // Update last refresh time on any HTMX response
                    document.body.addEventListener('htmx:afterSwap', updateLastRefreshTime);

                    // Course creation functions
                    function createCourse() {
                        if (!validatePasswordWithTimeout()) return;
                        
                        const bulkJson = document.getElementById('bulkCourseJson').value.trim();
                        let courseData;

                        try {
                            if (bulkJson) {
                                // Use bulk JSON format
                                courseData = JSON.parse(bulkJson);
                            } else {
                                // Use individual fields
                                const courseCode = document.getElementById('courseCode').value.trim();
                                const courseName = document.getElementById('courseName').value.trim();
                                const offeringDepartment = document.getElementById('offeringDepartment').value.trim();
                                const seatsAvailable = parseInt(document.getElementById('seatsAvailable').value);

                                if (!courseCode || !courseName || !offeringDepartment || !seatsAvailable) {
                                    throw new Error('Please fill in all course fields or provide bulk JSON data');
                                }

                                courseData = {
                                    courseCode: courseCode,
                                    courseName: courseName,
                                    offeringDepartment: offeringDepartment,
                                    seatsAvailable: seatsAvailable
                                };
                            }

                            // Make HTMX request to create course
                            fetch('/admin/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': password
                                },
                                body: JSON.stringify(courseData)
                            })
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                } else if (response.status === 401) {
                                    throw new Error('Unauthorized - Invalid admin password');
                                } else {
                                    return response.text().then(text => {
                                        throw new Error(text || 'Failed to create course');
                                    });
                                }
                            })
                            .then(data => {
                                const resultDiv = document.getElementById('course-creation-result');
                                resultDiv.innerHTML = `
                                    <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                                        <strong>Success:</strong> ${data.message}
                                    </div>
                                `;
                                clearCourseForm();
                                // Refresh course statistics
                                refreshCourseData();                            })
                            .catch(error => {
                                handleApiError(error, "creating course");
                                const resultDiv = document.getElementById('course-creation-result');
                                resultDiv.innerHTML = `
                                    <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                                        <strong>Error:</strong> ${error.message}
                                    </div>
                                `;
                            });

                        } catch (error) {
                            const resultDiv = document.getElementById('course-creation-result');
                            resultDiv.innerHTML = `
                                <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                                    <strong>Error:</strong> ${error.message}
                                </div>
                            `;
                        }
                    }

                    function clearCourseForm() {
                        document.getElementById('courseCode').value = '';
                        document.getElementById('courseName').value = '';
                        document.getElementById('offeringDepartment').value = '';
                        document.getElementById('seatsAvailable').value = '';
                        document.getElementById('bulkCourseJson').value = '';
                        document.getElementById('course-creation-result').innerHTML = '';
                    }

                    // Reset operation functions
                    function confirmReset(type) {
                        const messages = {
                            'courses': 'This will delete ALL courses from the database. Are you sure?',
                            'users': 'This will delete ALL users from the database. Are you sure?',
                            'all': 'This will delete ALL courses AND users from the database. Are you absolutely sure?'
                        };

                        const endpoints = {
                            'courses': '/admin/reset/courses',
                            'users': '/admin/reset/users',
                            'all': '/admin/reset/all'
                        };

                        if (confirm(messages[type])) {
                            if (type === 'all' && !confirm('This is your final warning. This action cannot be undone. Continue?')) {
                                return;
                            }
                            performReset(endpoints[type], type);
                        }
                    }                    function performReset(endpoint, type) {
                        if (!validatePasswordWithTimeout()) return;
                        
                        const resultDiv = document.getElementById('reset-operation-result');
                        resultDiv.innerHTML = `
                            <div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded">
                                <div class="flex items-center">
                                    <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Processing reset operation...
                                </div>
                            </div>
                        `;

                        fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Authorization': password
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.text();
                            } else if (response.status === 401) {
                                throw new Error('Unauthorized - Invalid admin password');
                            } else {
                                throw new Error('Reset operation failed');
                            }
                        })
                        .then(message => {
                            resultDiv.innerHTML = `
                                <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                                    <strong>Success:</strong> ${message}
                                </div>
                            `;
                            // Refresh data based on what was reset
                            if (type === 'courses' || type === 'all') {
                                refreshCourseData();
                            }
                            if (type === 'users' || type === 'all') {
                                refreshUserData();
                            }                        })
                        .catch(error => {
                            handleApiError(error, "performing reset operation");
                            resultDiv.innerHTML = `
                                <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                                    <strong>Error:</strong> ${error.message}
                                </div>
                            `;
                        });
                    }// Admin Actions toggle function
                    function toggleAdminActions() {
                        const content = document.getElementById('admin-actions-content');
                        const chevron = document.getElementById('admin-actions-chevron');
                        const isHidden = content.classList.contains('hidden');
                        
                        if (isHidden) {
                            content.classList.remove('hidden');
                            chevron.style.transform = 'rotate(180deg)';
                        } else {
                            content.classList.add('hidden');
                            chevron.style.transform = 'rotate(0deg)';
                        }
                    }

                    // Access Control Functions
                    function updateCurrentTime() {
                        const now = new Date();
                        const timeString = now.toLocaleString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        document.getElementById('current-time').textContent = timeString;
                    }                    function loadAccessSettings() {
                        if (!validatePasswordWithTimeout()) return;
                        
                        const resultDiv = document.getElementById('access-settings-result');
                        resultDiv.innerHTML = '<div class="text-blue-600">Loading current settings...</div>';

                        fetch('/admin/settings', {
                            method: 'POST',
                            headers: {
                                'Authorization': password,
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else if (response.status === 401) {
                                throw new Error('Unauthorized - Invalid admin password');
                            } else {
                                throw new Error('Failed to load settings');
                            }
                        })
                        .then(data => {
                            // Update form fields
                            if (data.allowedDateTime) {
                                const date = new Date(data.allowedDateTime);
                                const localISOTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                                document.getElementById('allowedDateTime').value = localISOTime;
                            }
                            document.getElementById('isEnabled').checked = data.isEnabled || false;

                            // Update status display
                            updateAccessStatus(data);                            resultDiv.innerHTML = `
                                <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                                    <strong>Success:</strong> Settings loaded successfully
                                </div>
                            `;
                        })
                        .catch(error => {
                            handleApiError(error, "loading access settings");
                            resultDiv.innerHTML = `
                                <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                                    <strong>Error:</strong> ${error.message}
                                </div>
                            `;
                        });
                    }                    function updateAccessSettings() {
                        if (!validatePasswordWithTimeout()) return;
                        
                        const allowedDateTime = document.getElementById('allowedDateTime').value;
                        const isEnabled = document.getElementById('isEnabled').checked;
                        const resultDiv = document.getElementById('access-settings-result');

                        if (!allowedDateTime) {
                            resultDiv.innerHTML = `
                                <div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded">
                                    <strong>Warning:</strong> Please select a date and time
                                </div>
                            `;
                            return;
                        }

                        resultDiv.innerHTML = '<div class="text-blue-600">Updating settings...</div>';

                        const requestData = {
                            allowedDateTime: new Date(allowedDateTime).toISOString(),
                            isEnabled: isEnabled
                        };

                        fetch('/admin/settings/update', {
                            method: 'POST',
                            headers: {
                                'Authorization': password,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else if (response.status === 401) {
                                throw new Error('Unauthorized - Invalid admin password');
                            } else {
                                throw new Error('Failed to update settings');
                            }
                        })
                        .then(data => {
                            updateAccessStatus(data);                            resultDiv.innerHTML = `
                                <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                                    <strong>Success:</strong> Access control settings updated successfully
                                </div>
                            `;
                        })
                        .catch(error => {
                            handleApiError(error, "updating access settings");
                            resultDiv.innerHTML = `
                                <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                                    <strong>Error:</strong> ${error.message}
                                </div>
                            `;
                        });
                    }

                    function updateAccessStatus(data) {
                        // Update allowed time display
                        if (data.allowedDateTime) {
                            const allowedDate = new Date(data.allowedDateTime);
                            const allowedTimeString = allowedDate.toLocaleString('en-US', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            });
                            document.getElementById('allowed-time').textContent = allowedTimeString;
                        } else {
                            document.getElementById('allowed-time').textContent = 'Not set';
                        }

                        // Update control enabled status
                        const controlEnabledElement = document.getElementById('control-enabled');
                        if (data.isEnabled) {
                            controlEnabledElement.textContent = 'Enabled';
                            controlEnabledElement.className = 'ml-2 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800';
                        } else {
                            controlEnabledElement.textContent = 'Disabled';
                            controlEnabledElement.className = 'ml-2 px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800';
                        }

                        // Update access status
                        checkAccessStatus();
                    }

                    function checkAccessStatus() {
                        fetch('/allowed')
                        .then(response => response.json())
                        .then(data => {
                            const accessStatusElement = document.getElementById('access-status');
                            if (data.allowed) {
                                accessStatusElement.textContent = 'ALLOWED';
                                accessStatusElement.className = 'ml-2 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800';
                            } else {
                                accessStatusElement.textContent = 'BLOCKED';
                                accessStatusElement.className = 'ml-2 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800';
                            }
                        })
                        .catch(error => {
                            console.error('Error checking access status:', error);
                            const accessStatusElement = document.getElementById('access-status');
                            accessStatusElement.textContent = 'ERROR';
                            accessStatusElement.className = 'ml-2 px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800';
                        });
                    }

                    // Initialize Access Control on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        // Update current time immediately and then every second
                        updateCurrentTime();
                        setInterval(updateCurrentTime, 1000);

                        // Load initial access settings
                        setTimeout(loadAccessSettings, 500);

                        // Refresh access status every 30 seconds
                        setInterval(checkAccessStatus, 30000);
                    });
                </script>
                <table class="table-auto w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Name</th>
                            <th class="px-4 py-2 text-left">Email</th>
                            <th class="px-4 py-2 text-left">Register ID</th>
                            <th class="px-4 py-2 text-left">Department</th>
                            <th class="px-4 py-2 text-left">Opted Course</th>
                        </tr>
                    </thead>                    <tbody hx-post="/admin/users" hx-headers='js:{"Authorization": password}' hx-swap="innerHTML"
                        hx-trigger="load, every 10s from:body" hx-indicator="#user-refresh-indicator">
                        <tr>
                            <td colspan="6" class="border px-4 py-2 text-center">
                                Loading user data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div> <button class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
            hx-post="/admin/users/csv" hx-headers='js:{"Authorization": password}' hx-trigger="click"
            hx-swap="innerHTML" hx-target="#download-link">Export CSV</button>
        <div id="download-link" class="mt-2"></div>        <!-- Keyboard Shortcuts Help -->
        <div class="mt-8 bg-gray-50 border rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Keyboard Shortcuts:</h3>            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-gray-600">
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+A</kbd> Toggle Admin Actions</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+N</kbd> New Course Form</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+R</kbd> Refresh All</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+C</kbd> Refresh Courses</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+U</kbd> Refresh Users</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+P</kbd> Toggle Auto-refresh</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+S</kbd> Update Access Settings</div>
                <div><kbd class="bg-gray-200 px-1 rounded">Ctrl+L</kbd> Load Access Settings</div>
                <div class="col-span-2 md:col-span-1"><kbd class="bg-gray-200 px-1 rounded">Ctrl+Shift+Del</kbd> Reset All (Dangerous!)</div>
            </div>
        </div>
    </div>
</body>

</html>